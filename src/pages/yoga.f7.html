<template>
  <div class="page">
    <div class="navbar">
      <div class="navbar-inner">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="if-ios">Back</span>
          </a>
        </div>
        <div class="title sliding">Yoga Stunden</div>
        <div class="right">
          <!-- Link to enable searchbar -->
          <a class="link icon-only searchbar-enable" data-searchbar="#searchbar-yoga">
            <i class="icon f7-icons ios-only">search_strong</i>
            <i class="icon material-icons md-only">search</i>
          </a>
        </div>
        <!-- Searchbar is a direct child of "navbar-inner" -->
        <form id="searchbar-yoga" class="searchbar searchbar-expandable searchbar-init">
          <div class="searchbar-inner">
            <div class="searchbar-input-wrap">
              <input type="search" placeholder="Search"/>
              <i class="searchbar-icon"></i>
              <span class="input-clear-button"></span>
            </div>
            <span class="searchbar-disable-button">Cancel</span>
          </div>
        </form>
      </div>
    </div>
    <div class="page-content infinite-scroll-content">

      <div class="list media-list no-hairlines">
        <ul id="yoga-items-list">
          <!--
          {{#each yogaItems}}
          <li>
            <a href="#" class="item-link item-content">
              <div class="item-media"><img src="https://cdn.framework7.io/placeholder/people-160x160-1.jpg" width="80"></div>
              <div class="item-inner">
                <div class="item-title-row">
                  <div class="item-title">{{this.title}}</div>
                  <div class="item-after"><i class="far fa-clock"></i>&nbsp;{{this.duration}} min</div>
                </div>
                <div class="item-subtitle"><i class="fas fa-headphones-alt"></i> {{this.speaker}}</div>
                <div class="item-text">{{this.teaserBody}}</div>
              </div>
            </a>
          </li>
          {{/each}}
          -->
        </ul>
      </div>
      <div id="scroll-preloader" class="preloader infinite-scroll-preloader"></div>
    </div>

  </div>
</template>
<script>

  import api from '../app/api';
  import {Dom7} from 'framework7/framework7.esm.bundle.js';
  import longscroller from '../app/longscroller';
  import helper from '../app/helper';
  import ImgCache from '../app/imgcache';
  import cache from '../app/cache';

  let $$ = Dom7;

  // Append items per load
  let itemsPerLoad = 10;

  function setItemsStepByStep(items) {

    let $list = $$('#yoga-items-list');

    let curent_index = 1;
    let items_per_interval = 10;

    items.slice(curent_index,(items_per_interval*(curent_index+1))).forEach((item) => {
      $list.append(listItem(item));
    });

    $list.show();

    var interval = setInterval(() => {
      items.slice(curent_index,(items_per_interval*(curent_index+1))).forEach((item) => {
        $list.append(listItem(item));
      });

      curent_index += items_per_interval;

      if(curent_index >= items.length) {
        clearInterval(interval);
        $$('.infinite-scroll-preloader').remove();
      }

    },100);


  }

  function listItem(item) {
    return `<li>
            <a href="/yoga/` + item.id + `/" class="item-link item-content">
              <div class="item-media"><div class="list-img-bg"><i class="fas fa-circle-notch fa-spin"></i></div></div>
              <div class="item-inner">
                <div class="item-title-row">
                  <div class="item-title">` + item.title + `</div>
                  <div class="item-after"><i class="far fa-clock"></i>&nbsp;` + item.duration + ` min</div>
                </div>
                <div class="item-text"><i class="fas fa-headphones-alt"></i> ` + item.speaker + `</div>
              </div>
            </a>
          </li>
          `;
  }

  function initScroll(items) {

    longscroller.init(items,{
      render: listItem,
      items_per_load: 10,
      load_delay: 200,
      onAppend: (item, $el) => {
        api.getItem(item.id, {
          cached: true,
          success: (litem) => {
            $el.find('.list-img-bg').css({
              'background-color': 'transparent',
              'background-image': 'url(' + litem.thumbnail_sm + ')'
            }).empty();
          }
        });
      }
    });
  }

  export default {
    data () {
      return {
        // empty initial user data
        yogaItems: [],
      }
    },
    on: {
      pageInit: function () {

        var self = this;
        var app = self.$app;


        api.getYoga({
          cached: true,
          success: (items) => {

            self.$setState({
              yogaItems: items.slice(0,15)
            });


            initScroll(items);
            cache.pages.yoga = {};

            //setItemsStepByStep(items);

          }
        });

      },
    },
  };
</script>
